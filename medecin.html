<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>M√©decin ‚Äî Cabinet M√©dical</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --cream: #f5f0e8;
      --white: #ffffff;
      --deep: #1a2639;
      --teal: #2a7f7f;
      --teal-light: #3aa3a3;
      --gold: #c9a84c;
      --red: #c0392b;
      --green: #27ae60;
      --orange: #e67e22;
      --gray: #8a9bb0;
      --border: #ddd6c8;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Cairo', sans-serif; background: var(--cream); min-height: 100vh; }

    /* LOGIN */
    .login-wrap {
      min-height: 100vh;
      display: flex; align-items: center; justify-content: center; padding: 20px;
    }
    .login-card {
      background: white; border-radius: 18px; padding: 40px 32px;
      width: 100%; max-width: 400px;
      box-shadow: 0 4px 24px rgba(26,38,57,0.10);
      border: 1px solid var(--border); text-align: center;
    }
    .login-card .icon { font-size: 48px; margin-bottom: 12px; }
    .login-card h2 { font-family: 'Playfair Display', serif; color: var(--deep); font-size: 22px; margin-bottom: 6px; }
    .login-card p { color: var(--gray); font-size: 13px; margin-bottom: 24px; }
    input, select {
      width: 100%; padding: 12px 16px;
      border: 1.5px solid var(--border); border-radius: 10px;
      font-family: 'Cairo', sans-serif; font-size: 15px;
      color: var(--deep); background: var(--cream);
      margin-bottom: 14px; outline: none;
    }
    input:focus, select:focus { border-color: var(--teal); background: white; }
    .btn {
      padding: 13px 20px;
      background: var(--teal); color: white;
      border: none; border-radius: 10px;
      font-family: 'Cairo', sans-serif; font-size: 15px; font-weight: 700;
      cursor: pointer; transition: background 0.2s;
    }
    .btn:hover { background: var(--teal-light); }
    .btn.full { width: 100%; }
    .btn.red { background: var(--red); }
    .btn.red:hover { background: #e74c3c; }
    .btn.green { background: var(--green); }
    .btn.green:hover { background: #2ecc71; }
    .btn.sm { padding: 8px 16px; font-size: 13px; }
    .error-login { color: var(--red); font-size: 13px; margin-top: 10px; display: none; }

    /* DASHBOARD */
    .dashboard { display: none; }
    .topbar {
      background: var(--deep); color: white;
      padding: 16px 28px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .topbar h1 { font-family: 'Playfair Display', serif; font-size: 20px; }
    .topbar .meta { font-size: 13px; color: var(--gray); }
    .logout-btn {
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      color: white; padding: 7px 16px; border-radius: 8px;
      cursor: pointer; font-family: 'Cairo', sans-serif; font-size: 13px;
    }
    .tabs {
      display: flex; background: white; border-bottom: 2px solid var(--border);
      padding: 0 28px;
    }
    .tab {
      padding: 14px 20px; font-size: 14px; font-weight: 600;
      color: var(--gray); cursor: pointer; border-bottom: 3px solid transparent;
      margin-bottom: -2px; transition: all 0.15s;
    }
    .tab.active { color: var(--teal); border-bottom-color: var(--teal); }
    .tab-content { display: none; padding: 24px 28px; }
    .tab-content.active { display: block; }

    /* STATS */
    .stats-row { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 24px; }
    .stat-card {
      background: white; border-radius: 12px; padding: 18px 22px;
      flex: 1; min-width: 130px;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(26,38,57,0.05);
    }
    .stat-card .val { font-size: 32px; font-weight: 700; color: var(--teal); font-family: 'Playfair Display', serif; }
    .stat-card .lbl { font-size: 12px; color: var(--gray); margin-top: 2px; }

    /* LIST */
    .list-wrap { background: white; border-radius: 14px; border: 1px solid var(--border); overflow: hidden; }
    .list-header {
      display: grid; grid-template-columns: 60px 1fr 140px 100px;
      padding: 12px 20px; background: #f8f6f2;
      border-bottom: 1px solid var(--border);
      font-size: 12px; font-weight: 700; color: var(--gray);
      text-transform: uppercase;
    }
    .list-item {
      display: grid; grid-template-columns: 60px 1fr 140px 100px;
      padding: 14px 20px; border-bottom: 1px solid #f0ece4; align-items: center;
    }
    .list-item:last-child { border-bottom: none; }
    .num-badge {
      width: 36px; height: 36px; background: var(--teal); color: white;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 15px; font-family: 'Playfair Display', serif;
    }
    .name-col { font-weight: 600; color: var(--deep); font-size: 14px; }
    .time-col { color: var(--gray); font-size: 12px; }
    .tel-col { color: var(--gray); font-size: 13px; }
    .empty-state { text-align: center; padding: 48px 20px; color: var(--gray); }
    .empty-state .ico { font-size: 48px; margin-bottom: 12px; }

    /* SETTINGS */
    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .settings-card {
      background: white; border-radius: 14px; border: 1px solid var(--border);
      padding: 24px; box-shadow: 0 2px 8px rgba(26,38,57,0.05);
    }
    .settings-card h3 { color: var(--deep); font-size: 15px; font-weight: 700; margin-bottom: 16px; }
    .toggle-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 0; border-bottom: 1px solid #f0ece4;
    }
    .toggle-row:last-child { border-bottom: none; }
    .toggle-label { font-size: 14px; color: var(--deep); }
    .toggle-sub { font-size: 12px; color: var(--gray); margin-top: 2px; }
    .toggle {
      position: relative; width: 48px; height: 26px;
    }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; inset: 0; background: #ccc;
      border-radius: 26px; cursor: pointer; transition: 0.3s;
    }
    .slider:before {
      content: ''; position: absolute;
      width: 20px; height: 20px; background: white;
      border-radius: 50%; left: 3px; top: 3px; transition: 0.3s;
    }
    input:checked + .slider { background: var(--teal); }
    input:checked + .slider:before { transform: translateX(22px); }
    .section-title { font-size: 16px; font-weight: 700; color: var(--deep); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
    .refresh-btn { background: none; border: 1.5px solid var(--teal); color: var(--teal); border-radius: 8px; padding: 5px 14px; font-size: 12px; cursor: pointer; font-family: 'Cairo', sans-serif; }
    .live-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }
    .save-msg { color: var(--green); font-size: 13px; margin-top: 10px; display: none; }
    .pwd-row { display: flex; gap: 10px; align-items: flex-end; }
    .pwd-row input { margin-bottom: 0; flex: 1; }
    .status-badge {
      display: inline-block; padding: 4px 12px; border-radius: 20px;
      font-size: 12px; font-weight: 700;
    }
    .status-open { background: #e8f8f0; color: var(--green); }
    .status-closed { background: #fdf2f2; color: var(--red); }
    @media (max-width: 600px) {
      .settings-grid { grid-template-columns: 1fr; }
      .list-header, .list-item { grid-template-columns: 50px 1fr 80px; }
      .list-header .col-tel, .list-item .tel-col { display: none; }
      .tabs { padding: 0 12px; }
      .tab { padding: 12px 12px; font-size: 13px; }
      .tab-content { padding: 16px; }
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="login-wrap" id="loginWrap">
  <div class="login-card">
    <div class="icon">üë®‚Äç‚öïÔ∏è</div>
    <h2>Espace M√©decin</h2>
    <p>Acc√®s s√©curis√© au tableau de bord</p>
    <input type="password" id="pwdInput" placeholder="Mot de passe" onkeydown="if(event.key==='Enter')login()"/>
    <button class="btn full" onclick="login()">Se connecter</button>
    <div class="error-login" id="loginErr">Mot de passe incorrect.</div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboard">
  <div class="topbar">
    <div>
      <h1>üè• Tableau de bord</h1>
      <div class="meta" id="dateDisplay"></div>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <span id="statusBadge"></span>
      <span><span class="live-dot"></span> <span style="font-size:12px;color:#8a9bb0;margin-left:4px;">Temps r√©el</span></span>
      <button class="logout-btn" onclick="logout()">D√©connexion</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('today')">üìã Aujourd'hui</div>
    <div class="tab" onclick="switchTab('settings')">‚öôÔ∏è Param√®tres</div>
    <div class="tab" onclick="switchTab('password')">üîí Mot de passe</div>
  </div>

  <!-- TODAY TAB -->
  <div class="tab-content active" id="tab-today">
    <div class="stats-row">
      <div class="stat-card">
        <div class="val" id="statTotal">0</div>
        <div class="lbl">Inscrits aujourd'hui</div>
      </div>
      <div class="stat-card">
        <div class="val" id="statLimit">‚Äî</div>
        <div class="lbl">Places max</div>
      </div>
      <div class="stat-card">
        <div class="val" id="statRemaining">‚Äî</div>
        <div class="lbl">Places restantes</div>
      </div>
    </div>
    <div class="section-title">
      üìã File d'attente
      <button class="refresh-btn" onclick="loadList()">‚Üª Actualiser</button>
    </div>
    <div class="list-wrap">
      <div class="list-header">
        <span>#</span>
        <span>Nom & Pr√©nom</span>
        <span class="col-tel">T√©l√©phone</span>
        <span>Heure</span>
      </div>
      <div id="listBody"></div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div class="tab-content" id="tab-settings">
    <div class="settings-grid">
      <div class="settings-card">
        <h3>üîß Param√®tres g√©n√©raux</h3>
        <div class="toggle-row">
          <div>
            <div class="toggle-label">Inscriptions ouvertes</div>
            <div class="toggle-sub">Permettre aux patients de s'inscrire</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="toggleOuvert" onchange="saveParams()"/>
            <span class="slider"></span>
          </label>
        </div>
        <div class="toggle-row">
          <div>
            <div class="toggle-label">Limite de patients</div>
            <div class="toggle-sub">Nombre max par jour (0 = illimit√©)</div>
          </div>
          <input type="number" id="limiteInput" min="0" max="200" style="width:80px;margin-bottom:0;padding:8px 10px;font-size:14px;" onchange="saveParams()"/>
        </div>
        <div class="save-msg" id="saveMsg">‚úì Param√®tres sauvegard√©s</div>
      </div>

      <div class="settings-card">
        <h3>üìä R√©sum√© du jour</h3>
        <div class="toggle-row">
          <div class="toggle-label">Statut actuel</div>
          <span id="statusText">‚Äî</span>
        </div>
        <div class="toggle-row">
          <div class="toggle-label">Patients inscrits</div>
          <span id="summaryTotal" style="font-weight:700;color:var(--teal)">0</span>
        </div>
        <div class="toggle-row">
          <div class="toggle-label">Places restantes</div>
          <span id="summaryRemaining" style="font-weight:700;color:var(--teal)">‚Äî</span>
        </div>
        <br/>
        <button class="btn red sm" onclick="clearDay()" style="width:100%">üóëÔ∏è Effacer la liste du jour</button>
      </div>
    </div>
  </div>

  <!-- PASSWORD TAB -->
  <div class="tab-content" id="tab-password">
    <div class="settings-card" style="max-width:450px">
      <h3>üîí Changer les mots de passe</h3>
      <br/>
      <label style="display:block;font-size:13px;font-weight:600;color:var(--deep);margin-bottom:8px;">Nouveau mot de passe ‚Äî M√©decin</label>
      <div class="pwd-row">
        <input type="password" id="newPwdMed" placeholder="Nouveau mot de passe m√©decin"/>
        <button class="btn sm" onclick="changePwd('medecin')">Changer</button>
      </div>
      <br/>
      <label style="display:block;font-size:13px;font-weight:600;color:var(--deep);margin-bottom:8px;">Nouveau mot de passe ‚Äî Assistante</label>
      <div class="pwd-row">
        <input type="password" id="newPwdAss" placeholder="Nouveau mot de passe assistante"/>
        <button class="btn sm" onclick="changePwd('assistante')">Changer</button>
      </div>
      <div class="save-msg" id="pwdMsg">‚úì Mot de passe mis √† jour</div>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://rynxvdqjplqccekulcfe.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bnh2ZHFqcGxxY2Nla3VsY2ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNDY5ODQsImV4cCI6MjA4NzcyMjk4NH0.Ab-HQgVhGzxdyXbY8xeFF0HveQGxstNgEIUeELVPWk8';
  let refreshInterval;
  let currentParams = {};

  async function login() {
    const pwd = document.getElementById('pwdInput').value;
    const res = await fetch(`${SUPABASE_URL}/rest/v1/utilisateurs?role=eq.medecin`, {
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
    });
    const data = await res.json();
    if (data.length > 0 && data[0].mot_de_passe === pwd) {
      document.getElementById('loginWrap').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      setDate();
      loadAll();
      refreshInterval = setInterval(loadList, 15000);
    } else {
      document.getElementById('loginErr').style.display = 'block';
    }
  }

  function logout() {
    clearInterval(refreshInterval);
    document.getElementById('loginWrap').style.display = 'flex';
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('pwdInput').value = '';
    document.getElementById('loginErr').style.display = 'none';
  }

  function setDate() {
    document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  }

  function switchTab(name) {
    document.querySelectorAll('.tab').forEach((t,i) => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-'+name).classList.add('active');
    event.target.classList.add('active');
  }

  async function loadAll() {
    await loadParams();
    await loadList();
  }

  async function loadParams() {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/parametres?id=eq.1`, {
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
    });
    const data = await res.json();
    if (data.length > 0) {
      currentParams = data[0];
      document.getElementById('toggleOuvert').checked = data[0].ouvert;
      document.getElementById('limiteInput').value = data[0].limite_patients || 0;
    }
  }

  async function loadList() {
    const today = new Date().toISOString().split('T')[0];
    const [listRes, paramRes] = await Promise.all([
      fetch(`${SUPABASE_URL}/rest/v1/inscriptions?date_inscription=eq.${today}&order=position.asc`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      }),
      fetch(`${SUPABASE_URL}/rest/v1/parametres?id=eq.1`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      })
    ]);
    const list = await listRes.json();
    const params = (await paramRes.json())[0] || {};
    currentParams = params;

    const total = list.length;
    const limit = params.limite_patients || 0;
    const rem = limit ? Math.max(0, limit - total) : '‚àû';

    document.getElementById('statTotal').textContent = total;
    document.getElementById('statLimit').textContent = limit || '‚àû';
    document.getElementById('statRemaining').textContent = rem;
    document.getElementById('summaryTotal').textContent = total;
    document.getElementById('summaryRemaining').textContent = rem;

    const isOpen = params.ouvert && (!limit || total < limit);
    const badge = isOpen
      ? '<span class="status-badge status-open">‚úì Ouvert</span>'
      : '<span class="status-badge status-closed">‚úó Ferm√©</span>';
    document.getElementById('statusBadge').innerHTML = badge;
    document.getElementById('statusText').innerHTML = badge;

    const body = document.getElementById('listBody');
    if (list.length === 0) {
      body.innerHTML = `<div class="empty-state"><div class="ico">üì≠</div><p>Aucun patient inscrit pour aujourd'hui.</p></div>`;
      return;
    }
    body.innerHTML = list.map(p => {
      const time = new Date(p.created_at).toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
      return `<div class="list-item">
        <div><div class="num-badge">${p.position}</div></div>
        <div class="name-col">${p.nom} ${p.prenom}</div>
        <div class="tel-col">${p.telephone}</div>
        <div class="time-col">${time}</div>
      </div>`;
    }).join('');
  }

  async function saveParams() {
    const ouvert = document.getElementById('toggleOuvert').checked;
    const limite = parseInt(document.getElementById('limiteInput').value) || 0;
    await fetch(`${SUPABASE_URL}/rest/v1/parametres?id=eq.1`, {
      method: 'PATCH',
      headers: {
        'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ ouvert, limite_patients: limite })
    });
    const msg = document.getElementById('saveMsg');
    msg.style.display = 'block';
    setTimeout(() => msg.style.display = 'none', 2500);
    loadList();
  }

  async function clearDay() {
    if (!confirm('Effacer toute la liste du jour ? Cette action est irr√©versible.')) return;
    const today = new Date().toISOString().split('T')[0];
    await fetch(`${SUPABASE_URL}/rest/v1/inscriptions?date_inscription=eq.${today}`, {
      method: 'DELETE',
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
    });
    loadList();
  }

  async function changePwd(role) {
    const inputId = role === 'medecin' ? 'newPwdMed' : 'newPwdAss';
    const newPwd = document.getElementById(inputId).value.trim();
    if (!newPwd) { alert('Veuillez entrer un nouveau mot de passe.'); return; }
    await fetch(`${SUPABASE_URL}/rest/v1/utilisateurs?role=eq.${role}`, {
      method: 'PATCH',
      headers: {
        'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ mot_de_passe: newPwd })
    });
    document.getElementById(inputId).value = '';
    const msg = document.getElementById('pwdMsg');
    msg.style.display = 'block';
    setTimeout(() => msg.style.display = 'none', 2500);
  }

  document.getElementById('pwdInput').addEventListener('keydown', e => { if(e.key==='Enter') login(); });
</script>
</body>
</html>
