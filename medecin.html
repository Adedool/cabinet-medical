<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rendz ‚Äî M√©decin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --blue: #1a56db; --blue-dark: #1341b0; --blue-light: #e8f0fe;
      --white: #ffffff; --gray-50: #f8fafc; --gray-100: #f1f5f9;
      --gray-200: #e2e8f0; --gray-300: #cbd5e1; --gray-400: #94a3b8;
      --gray-500: #64748b; --gray-700: #334155; --gray-900: #0f172a;
      --green: #16a34a; --green-light: #f0fdf4; --green-border: #bbf7d0;
      --orange: #ea580c; --orange-light: #fff7ed;
      --red: #dc2626; --red-light: #fef2f2; --red-border: #fecaca;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--gray-50); min-height: 100vh; }

    .login-wrap { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .login-card { background: white; border-radius: 20px; padding: 40px 36px; width: 100%; max-width: 400px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); border: 1px solid var(--gray-200); text-align: center; }
    .login-logo { font-family: 'DM Sans', sans-serif; font-size: 32px; font-weight: 700; color: var(--blue); letter-spacing: -0.5px; margin-bottom: 4px; }
    .login-logo span { color: var(--gray-900); }
    .login-role { font-size: 13px; color: var(--gray-500); margin-bottom: 28px; font-weight: 500; }
    .login-icon { font-size: 40px; margin-bottom: 12px; }
    .login-input { width: 100%; padding: 12px 14px; border: 1.5px solid var(--gray-200); border-radius: 10px; font-family: 'Inter', sans-serif; font-size: 15px; color: var(--gray-900); background: var(--gray-50); margin-bottom: 14px; outline: none; }
    .login-input:focus { border-color: var(--blue); background: white; }
    .login-btn { width: 100%; padding: 13px; background: var(--blue); color: white; border: none; border-radius: 10px; font-family: 'Inter', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer; }
    .login-btn:hover { background: var(--blue-dark); }
    .login-err { color: var(--red); font-size: 13px; margin-top: 10px; display: none; }

    .dashboard { display: none; }
    .topbar { background: var(--white); border-bottom: 1px solid var(--gray-200); padding: 14px 28px; display: flex; align-items: center; justify-content: space-between; }
    .topbar-logo { font-family: 'DM Sans', sans-serif; font-size: 20px; font-weight: 700; color: var(--blue); }
    .topbar-logo span { color: var(--gray-900); }
    .topbar-right { display: flex; align-items: center; gap: 12px; }
    .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status-pill.open { background: var(--green-light); color: var(--green); }
    .status-pill.closed { background: var(--red-light); color: var(--red); }
    .logout-btn { background: var(--gray-100); border: 1px solid var(--gray-200); color: var(--gray-700); padding: 7px 14px; border-radius: 8px; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 500; }
    .logout-btn:hover { background: var(--gray-200); }

    .tabs { display: flex; background: white; border-bottom: 1px solid var(--gray-200); padding: 0 28px; }
    .tab { padding: 14px 18px; font-size: 13px; font-weight: 600; color: var(--gray-500); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.15s; }
    .tab.active { color: var(--blue); border-bottom-color: var(--blue); }
    .tab-content { display: none; padding: 24px 28px; }
    .tab-content.active { display: block; }

    .stats-row { display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 24px; }
    .stat-card { background: white; border-radius: 12px; padding: 18px 20px; flex: 1; min-width: 120px; border: 1px solid var(--gray-200); }
    .stat-val { font-family: 'DM Sans', sans-serif; font-size: 30px; font-weight: 700; color: var(--blue); }
    .stat-lbl { font-size: 11px; color: var(--gray-500); margin-top: 2px; font-weight: 500; }

    .list-wrap { background: white; border-radius: 14px; border: 1px solid var(--gray-200); overflow: hidden; }
    .list-header { display: grid; grid-template-columns: 46px 1fr 130px 100px; padding: 10px 18px; background: var(--gray-50); border-bottom: 1px solid var(--gray-200); font-size: 11px; font-weight: 600; color: var(--gray-500); text-transform: uppercase; }
    .list-item { display: grid; grid-template-columns: 46px 1fr 130px 100px; padding: 13px 18px; border-bottom: 1px solid var(--gray-100); align-items: center; }
    .list-item:last-child { border-bottom: none; }
    .list-item.en_cours { background: var(--orange-light); border-left: 3px solid var(--orange); }
    .list-item.termine { opacity: 0.4; }
    .list-item.absent { opacity: 0.5; }
    .num-badge { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; color: white; background: var(--blue); font-family: 'DM Sans', sans-serif; }
    .num-badge.present { background: var(--green); }
    .num-badge.en_cours { background: var(--orange); }
    .num-badge.absent { background: var(--gray-400); }
    .num-badge.termine { background: var(--gray-300); }
    .name-col { font-weight: 600; color: var(--gray-900); font-size: 14px; }
    .name-col .tel { font-size: 12px; color: var(--gray-500); font-weight: 400; margin-top: 1px; }
    .status-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .status-badge.en_attente { background: var(--gray-100); color: var(--gray-500); }
    .status-badge.present { background: var(--green-light); color: var(--green); }
    .status-badge.en_cours { background: var(--orange-light); color: var(--orange); }
    .status-badge.absent { background: var(--gray-100); color: var(--gray-400); }
    .status-badge.termine { background: var(--gray-100); color: var(--gray-300); }
    .time-col { font-size: 12px; color: var(--gray-500); }
    .empty-state { text-align: center; padding: 48px 20px; color: var(--gray-400); }

    /* SETTINGS */
    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .settings-card { background: white; border-radius: 14px; border: 1px solid var(--gray-200); padding: 24px; }
    .settings-card h3 { font-size: 14px; font-weight: 700; color: var(--gray-900); margin-bottom: 18px; }
    .setting-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--gray-100); }
    .setting-row:last-child { border-bottom: none; }
    .setting-label { font-size: 14px; color: var(--gray-900); font-weight: 500; }
    .setting-sub { font-size: 12px; color: var(--gray-500); margin-top: 2px; }
    .toggle { position: relative; width: 44px; height: 24px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; inset: 0; background: var(--gray-300); border-radius: 24px; cursor: pointer; transition: 0.2s; }
    .slider:before { content: ''; position: absolute; width: 18px; height: 18px; background: white; border-radius: 50%; left: 3px; top: 3px; transition: 0.2s; }
    input:checked + .slider { background: var(--blue); }
    input:checked + .slider:before { transform: translateX(20px); }
    .num-input { width: 80px; padding: 8px 10px; border: 1.5px solid var(--gray-200); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 14px; text-align: center; outline: none; }
    .num-input:focus { border-color: var(--blue); }
    .save-note { color: var(--green); font-size: 12px; margin-top: 10px; display: none; font-weight: 500; }
    .danger-btn { width: 100%; padding: 10px; background: var(--red-light); color: var(--red); border: 1px solid var(--red-border); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; }
    .danger-btn:hover { background: var(--red); color: white; }
    .pwd-row { display: flex; gap: 8px; margin-bottom: 14px; }
    .pwd-row input { flex: 1; padding: 10px 12px; border: 1.5px solid var(--gray-200); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 14px; outline: none; }
    .pwd-row input:focus { border-color: var(--blue); }
    .pwd-btn { padding: 10px 16px; background: var(--blue); color: white; border: none; border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; }
    .pwd-btn:hover { background: var(--blue-dark); }
    .pwd-label { font-size: 12px; font-weight: 600; color: var(--gray-500); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.3px; }

    .refresh-btn { background: none; border: 1.5px solid var(--gray-200); color: var(--gray-500); border-radius: 8px; padding: 4px 12px; font-size: 12px; cursor: pointer; font-family: 'Inter', sans-serif; font-weight: 500; }
    .refresh-btn:hover { border-color: var(--blue); color: var(--blue); }
    .section-title { font-size: 15px; font-weight: 700; color: var(--gray-900); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }

    @media (max-width: 700px) {
      .settings-grid { grid-template-columns: 1fr; }
      .list-header, .list-item { grid-template-columns: 42px 1fr 90px; }
      .list-header span:nth-child(4), .list-item .time-col { display: none; }
      .tabs { padding: 0 16px; } .tab { padding: 12px 12px; font-size: 12px; }
      .tab-content { padding: 16px; } .topbar { padding: 12px 16px; }
    }
  </style>
</head>
<body>

<div class="login-wrap" id="loginWrap">
  <div class="login-card">
    <div class="login-logo">Rend<span>z</span></div>
    <div class="login-role">Espace M√©decin</div>
    <div class="login-icon">üë®‚Äç‚öïÔ∏è</div>
    <input class="login-input" type="password" id="pwdInput" placeholder="Mot de passe" onkeydown="if(event.key==='Enter')login()"/>
    <button class="login-btn" onclick="login()">Se connecter</button>
    <div class="login-err" id="loginErr">Mot de passe incorrect.</div>
  </div>
</div>

<div class="dashboard" id="dashboard">
  <div class="topbar">
    <div class="topbar-logo">Rend<span>z</span></div>
    <div class="topbar-right">
      <span id="statusPill"></span>
      <button class="logout-btn" onclick="logout()">D√©connexion</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('today', this)">üìã Aujourd'hui</div>
    <div class="tab" onclick="switchTab('settings', this)">‚öôÔ∏è Param√®tres</div>
    <div class="tab" onclick="switchTab('password', this)">üîí Mots de passe</div>
  </div>

  <!-- TODAY -->
  <div class="tab-content active" id="tab-today">
    <div class="stats-row">
      <div class="stat-card"><div class="stat-val" id="statTotal">0</div><div class="stat-lbl">Inscrits</div></div>
      <div class="stat-card"><div class="stat-val" id="statPresent">0</div><div class="stat-lbl">Pr√©sents</div></div>
      <div class="stat-card"><div class="stat-val" id="statAbsent">0</div><div class="stat-lbl">Absents</div></div>
      <div class="stat-card"><div class="stat-val" id="statTermine">0</div><div class="stat-lbl">Termin√©s</div></div>
    </div>
    <div class="section-title">
      File d'attente
      <button class="refresh-btn" onclick="loadList()">‚Üª Actualiser</button>
    </div>
    <div class="list-wrap">
      <div class="list-header"><span>#</span><span>Patient</span><span>Statut</span><span>Heure</span></div>
      <div id="listBody"></div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="tab-content" id="tab-settings">
    <div class="settings-grid">
      <div class="settings-card">
        <h3>‚öôÔ∏è Param√®tres du cabinet</h3>
        <div class="setting-row">
          <div><div class="setting-label">Inscriptions ouvertes</div><div class="setting-sub">Autoriser les nouvelles inscriptions</div></div>
          <label class="toggle"><input type="checkbox" id="toggleOuvert" onchange="saveParams()"/><span class="slider"></span></label>
        </div>
        <div class="setting-row">
          <div><div class="setting-label">Limite de patients</div><div class="setting-sub">0 = illimit√©</div></div>
          <input class="num-input" type="number" id="limiteInput" min="0" max="200" onchange="saveParams()"/>
        </div>
        <div class="save-note" id="saveNote">‚úì Sauvegard√©</div>
      </div>
      <div class="settings-card">
        <h3>üìä R√©sum√© du jour</h3>
        <div class="setting-row"><div class="setting-label">Statut</div><span id="statusResume">‚Äî</span></div>
        <div class="setting-row"><div class="setting-label">Patients inscrits</div><span id="resumeTotal" style="font-weight:700;color:var(--blue)">0</span></div>
        <div class="setting-row"><div class="setting-label">Places restantes</div><span id="resumeRem" style="font-weight:700;color:var(--blue)">‚Äî</span></div>
        <br/>
        <button class="danger-btn" onclick="clearDay()">üóëÔ∏è Effacer la liste du jour</button>
      </div>
    </div>
  </div>

  <!-- PASSWORD -->
  <div class="tab-content" id="tab-password">
    <div class="settings-card" style="max-width:460px">
      <h3>üîí Changer les mots de passe</h3>
      <br/>
      <div class="pwd-label">Mot de passe ‚Äî M√©decin</div>
      <div class="pwd-row">
        <input type="password" id="newPwdMed" placeholder="Nouveau mot de passe"/>
        <button class="pwd-btn" onclick="changePwd('medecin')">Changer</button>
      </div>
      <div class="pwd-label">Mot de passe ‚Äî Assistante</div>
      <div class="pwd-row">
        <input type="password" id="newPwdAss" placeholder="Nouveau mot de passe"/>
        <button class="pwd-btn" onclick="changePwd('assistante')">Changer</button>
      </div>
      <div class="save-note" id="pwdNote">‚úì Mot de passe mis √† jour</div>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://rynxvdqjplqccekulcfe.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bnh2ZHFqcGxxY2Nla3VsY2ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNDY5ODQsImV4cCI6MjA4NzcyMjk4NH0.Ab-HQgVhGzxdyXbY8xeFF0HveQGxstNgEIUeELVPWk8';
  let refreshInterval;
  const SL = { en_attente: 'En attente', present: 'Pr√©sent', en_cours: 'En consultation', absent: 'Absent', termine: 'Termin√©' };

  async function login() {
    const pwd = document.getElementById('pwdInput').value;
    const res = await fetch(`${SUPABASE_URL}/rest/v1/utilisateurs?role=eq.medecin`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
    const data = await res.json();
    if (data.length > 0 && data[0].mot_de_passe === pwd) {
      document.getElementById('loginWrap').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      loadAll();
      refreshInterval = setInterval(loadList, 15000);
    } else { document.getElementById('loginErr').style.display = 'block'; }
  }

  function logout() {
    clearInterval(refreshInterval);
    document.getElementById('loginWrap').style.display = 'flex';
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('pwdInput').value = '';
  }

  function switchTab(name, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('tab-' + name).classList.add('active');
  }

  async function loadAll() { await loadParams(); await loadList(); }

  async function loadParams() {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/parametres?id=eq.1`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
    const data = await res.json();
    if (data.length > 0) {
      document.getElementById('toggleOuvert').checked = data[0].ouvert;
      document.getElementById('limiteInput').value = data[0].limite_patients || 0;
    }
  }

  async function loadList() {
    const today = new Date().toISOString().split('T')[0];
    const [listRes, paramRes] = await Promise.all([
      fetch(`${SUPABASE_URL}/rest/v1/inscriptions?date_inscription=eq.${today}&order=position.asc`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }),
      fetch(`${SUPABASE_URL}/rest/v1/parametres?id=eq.1`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } })
    ]);
    const list = await listRes.json();
    const params = (await paramRes.json())[0] || {};
    const total = list.length;
    const limit = params.limite_patients || 0;
    const rem = limit ? Math.max(0, limit - total) : '‚àû';
    const isOpen = params.ouvert && (!limit || total < limit);

    document.getElementById('statTotal').textContent = total;
    document.getElementById('statPresent').textContent = list.filter(p => p.statut === 'present').length;
    document.getElementById('statAbsent').textContent = list.filter(p => p.statut === 'absent').length;
    document.getElementById('statTermine').textContent = list.filter(p => p.statut === 'termine').length;
    document.getElementById('resumeTotal').textContent = total;
    document.getElementById('resumeRem').textContent = rem;

    const pill = isOpen
      ? '<span class="status-pill open">‚úì Ouvert</span>'
      : '<span class="status-pill closed">‚úó Ferm√©</span>';
    document.getElementById('statusPill').innerHTML = pill;
    document.getElementById('statusResume').innerHTML = pill;

    const body = document.getElementById('listBody');
    if (list.length === 0) { body.innerHTML = `<div class="empty-state"><p>Aucun patient inscrit pour aujourd'hui.</p></div>`; return; }
    body.innerHTML = list.map(p => {
      const st = p.statut || 'en_attente';
      const bc = st === 'present' ? 'present' : st === 'en_cours' ? 'en_cours' : st === 'absent' ? 'absent' : st === 'termine' ? 'termine' : '';
      const time = new Date(p.created_at).toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
      return `<div class="list-item ${st}">
        <div><div class="num-badge ${bc}">${p.position}</div></div>
        <div class="name-col">${p.nom} ${p.prenom}<div class="tel">${p.telephone !== '‚Äî' ? p.telephone : ''}</div></div>
        <div><span class="status-badge ${st}">${SL[st] || st}</span></div>
        <div class="time-col">${time}</div>
      </div>`;
    }).join('');
  }

  async function saveParams() {
    const ouvert = document.getElementById('toggleOuvert').checked;
    const limite = parseInt(document.getElementById('limiteInput').value) || 0;
    await fetch(`${SUPABASE_URL}/rest/v1/parametres?id=eq.1`, { method: 'PATCH', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ ouvert, limite_patients: limite }) });
    const n = document.getElementById('saveNote');
    n.style.display = 'block';
    setTimeout(() => n.style.display = 'none', 2500);
    loadList();
  }

  async function clearDay() {
    if (!confirm('Effacer toute la liste du jour ?')) return;
    const today = new Date().toISOString().split('T')[0];
    await fetch(`${SUPABASE_URL}/rest/v1/inscriptions?date_inscription=eq.${today}`, { method: 'DELETE', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
    loadList();
  }

  async function changePwd(role) {
    const inputId = role === 'medecin' ? 'newPwdMed' : 'newPwdAss';
    const newPwd = document.getElementById(inputId).value.trim();
    if (!newPwd) { alert('Entrez un nouveau mot de passe.'); return; }
    await fetch(`${SUPABASE_URL}/rest/v1/utilisateurs?role=eq.${role}`, { method: 'PATCH', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ mot_de_passe: newPwd }) });
    document.getElementById(inputId).value = '';
    const n = document.getElementById('pwdNote');
    n.style.display = 'block';
    setTimeout(() => n.style.display = 'none', 2500);
  }

  document.getElementById('pwdInput').addEventListener('keydown', e => { if(e.key==='Enter') login(); });
</script>
</body>
</html>
