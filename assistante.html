<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rendz ‚Äî Assistante</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --blue: #1a56db; --blue-dark: #1341b0; --blue-light: #e8f0fe;
      --white: #ffffff; --gray-50: #f8fafc; --gray-100: #f1f5f9;
      --gray-200: #e2e8f0; --gray-300: #cbd5e1; --gray-400: #94a3b8;
      --gray-500: #64748b; --gray-700: #334155; --gray-900: #0f172a;
      --green: #16a34a; --green-light: #f0fdf4; --green-border: #bbf7d0;
      --orange: #ea580c; --orange-light: #fff7ed; --orange-border: #fed7aa;
      --red: #dc2626; --red-light: #fef2f2; --red-border: #fecaca;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--gray-50); min-height: 100vh; }

    /* LOGIN */
    .login-wrap { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background: var(--gray-50); }
    .login-card { background: white; border-radius: 20px; padding: 40px 36px; width: 100%; max-width: 400px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); border: 1px solid var(--gray-200); text-align: center; }
    .login-logo { font-family: 'DM Sans', sans-serif; font-size: 32px; font-weight: 700; color: var(--blue); letter-spacing: -0.5px; margin-bottom: 4px; }
    .login-logo span { color: var(--gray-900); }
    .login-role { font-size: 13px; color: var(--gray-500); margin-bottom: 28px; font-weight: 500; }
    .login-icon { font-size: 40px; margin-bottom: 12px; }
    .login-input { width: 100%; padding: 12px 14px; border: 1.5px solid var(--gray-200); border-radius: 10px; font-family: 'Inter', sans-serif; font-size: 15px; color: var(--gray-900); background: var(--gray-50); margin-bottom: 14px; outline: none; }
    .login-input:focus { border-color: var(--blue); background: white; }
    .login-btn { width: 100%; padding: 13px; background: var(--blue); color: white; border: none; border-radius: 10px; font-family: 'Inter', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer; }
    .login-btn:hover { background: var(--blue-dark); }
    .login-err { color: var(--red); font-size: 13px; margin-top: 10px; display: none; }

    /* DASHBOARD */
    .dashboard { display: none; }
    .topbar { background: var(--white); border-bottom: 1px solid var(--gray-200); padding: 14px 28px; display: flex; align-items: center; justify-content: space-between; }
    .topbar-logo { font-family: 'DM Sans', sans-serif; font-size: 20px; font-weight: 700; color: var(--blue); }
    .topbar-logo span { color: var(--gray-900); }
    .topbar-right { display: flex; align-items: center; gap: 14px; }
    .topbar-date { font-size: 13px; color: var(--gray-500); }
    .live-dot { width: 7px; height: 7px; background: #4ade80; border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }
    .logout-btn { background: var(--gray-100); border: 1px solid var(--gray-200); color: var(--gray-700); padding: 7px 14px; border-radius: 8px; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 500; }
    .logout-btn:hover { background: var(--gray-200); }

    /* CONSULT BAR */
    .consult-bar { background: var(--orange); padding: 16px 28px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
    .consult-label { font-size: 11px; color: rgba(255,255,255,0.75); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
    .consult-number { font-family: 'DM Sans', sans-serif; font-size: 40px; font-weight: 700; color: white; line-height: 1; }
    .consult-name { font-size: 13px; color: rgba(255,255,255,0.85); margin-top: 3px; }
    .fin-btn { background: white; color: var(--orange); border: none; border-radius: 10px; padding: 11px 22px; font-family: 'Inter', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.15s; }
    .fin-btn:hover { background: var(--gray-900); color: white; }
    .no-consult { background: var(--gray-100); border-bottom: 1px solid var(--gray-200); padding: 12px 28px; font-size: 13px; color: var(--gray-500); display: flex; align-items: center; gap: 8px; }

    /* STATS */
    .stats-row { display: flex; gap: 12px; padding: 20px 28px 0; flex-wrap: wrap; }
    .stat-card { background: white; border-radius: 12px; padding: 16px 18px; flex: 1; min-width: 100px; border: 1px solid var(--gray-200); }
    .stat-val { font-family: 'DM Sans', sans-serif; font-size: 28px; font-weight: 700; color: var(--blue); }
    .stat-lbl { font-size: 11px; color: var(--gray-500); margin-top: 2px; font-weight: 500; }

    /* CONTENT */
    .content { padding: 20px 28px; }
    .two-col { display: grid; grid-template-columns: 1fr 320px; gap: 20px; align-items: start; }
    .section-title { font-size: 15px; font-weight: 700; color: var(--gray-900); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
    .refresh-btn { background: none; border: 1.5px solid var(--gray-200); color: var(--gray-500); border-radius: 8px; padding: 4px 12px; font-size: 12px; cursor: pointer; font-family: 'Inter', sans-serif; font-weight: 500; }
    .refresh-btn:hover { border-color: var(--blue); color: var(--blue); }

    /* LIST */
    .list-wrap { background: white; border-radius: 14px; border: 1px solid var(--gray-200); overflow: hidden; }
    .list-header { display: grid; grid-template-columns: 46px 1fr 110px 210px; padding: 10px 18px; background: var(--gray-50); border-bottom: 1px solid var(--gray-200); font-size: 11px; font-weight: 600; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.3px; }
    .list-item { display: grid; grid-template-columns: 46px 1fr 110px 210px; padding: 12px 18px; border-bottom: 1px solid var(--gray-100); align-items: center; transition: background 0.1s; }
    .list-item:last-child { border-bottom: none; }
    .list-item:hover { background: var(--gray-50); }
    .list-item.en_cours { background: var(--orange-light); border-left: 3px solid var(--orange); }
    .list-item.absent { opacity: 0.5; }
    .list-item.termine { opacity: 0.4; }
    .list-item.manuel { border-left: 3px solid var(--blue); }

    .num-badge { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; font-family: 'DM Sans', sans-serif; color: white; background: var(--blue); }
    .num-badge.present { background: var(--green); }
    .num-badge.en_cours { background: var(--orange); }
    .num-badge.absent { background: var(--gray-400); }
    .num-badge.termine { background: var(--gray-300); }

    .name-col { font-weight: 600; color: var(--gray-900); font-size: 14px; }
    .name-col .tel { font-size: 12px; color: var(--gray-500); font-weight: 400; margin-top: 1px; }
    .name-col .tag-manuel { font-size: 10px; background: var(--blue-light); color: var(--blue); border-radius: 4px; padding: 1px 6px; margin-left: 6px; font-weight: 600; }

    .status-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .status-badge.en_attente { background: var(--gray-100); color: var(--gray-500); }
    .status-badge.present { background: var(--green-light); color: var(--green); }
    .status-badge.en_cours { background: var(--orange-light); color: var(--orange); }
    .status-badge.absent { background: var(--gray-100); color: var(--gray-400); }
    .status-badge.termine { background: var(--gray-100); color: var(--gray-300); }

    .actions-col { display: flex; gap: 5px; flex-wrap: wrap; justify-content: flex-end; }
    .action-btn { border: none; border-radius: 6px; padding: 5px 10px; font-size: 11px; cursor: pointer; font-family: 'Inter', sans-serif; font-weight: 600; transition: all 0.12s; white-space: nowrap; }
    .btn-present { background: var(--green-light); color: var(--green); border: 1px solid var(--green-border); }
    .btn-present:hover { background: var(--green); color: white; }
    .btn-encours { background: var(--orange-light); color: var(--orange); border: 1px solid var(--orange-border); }
    .btn-encours:hover { background: var(--orange); color: white; }
    .btn-fin { background: var(--green); color: white; border: 1px solid var(--green); }
    .btn-fin:hover { background: #15803d; }
    .btn-absent { background: var(--gray-100); color: var(--gray-500); border: 1px solid var(--gray-200); }
    .btn-absent:hover { background: var(--gray-400); color: white; }
    .btn-restore { background: var(--blue-light); color: var(--blue); border: 1px solid #bfdbfe; }
    .btn-restore:hover { background: var(--blue); color: white; }
    .btn-del { background: var(--red-light); color: var(--red); border: 1px solid var(--red-border); }
    .btn-del:hover { background: var(--red); color: white; }

    .empty-state { text-align: center; padding: 48px 20px; color: var(--gray-400); }
    .empty-state .ico { font-size: 40px; margin-bottom: 10px; }
    .empty-state p { font-size: 14px; }

    /* MANUAL FORM */
    .manual-form { background: white; border-radius: 14px; border: 1px solid var(--gray-200); padding: 20px; position: sticky; top: 20px; }
    .manual-form h3 { font-size: 14px; font-weight: 700; color: var(--gray-900); margin-bottom: 16px; }
    .mform-group { margin-bottom: 12px; }
    .mform-label { display: block; font-size: 11px; font-weight: 600; color: var(--gray-500); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.3px; }
    .mform-input { width: 100%; padding: 10px 12px; border: 1.5px solid var(--gray-200); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 14px; color: var(--gray-900); background: var(--gray-50); outline: none; }
    .mform-input:focus { border-color: var(--blue); background: white; }
    .add-btn { width: 100%; padding: 11px; background: var(--gray-900); color: white; border: none; border-radius: 9px; font-family: 'Inter', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.15s; margin-top: 4px; }
    .add-btn:hover { background: var(--blue); }
    .add-btn:disabled { background: var(--gray-300); cursor: not-allowed; }
    .add-success { background: var(--green-light); border: 1px solid var(--green-border); border-radius: 8px; padding: 10px 12px; color: var(--green); font-size: 13px; font-weight: 600; text-align: center; margin-top: 10px; display: none; }

    @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } .manual-form { position: static; } }
    @media (max-width: 640px) {
      .list-header, .list-item { grid-template-columns: 42px 1fr 170px; }
      .list-header span:nth-child(3), .list-item .status-col { display: none; }
      .stats-row { gap: 8px; } .content, .topbar { padding-left: 16px; padding-right: 16px; }
      .stats-row { padding: 14px 16px 0; } .consult-bar, .no-consult { padding-left: 16px; padding-right: 16px; }
    }
  </style>
</head>
<body>

<div class="login-wrap" id="loginWrap">
  <div class="login-card">
    <div class="login-logo">Rend<span>z</span></div>
    <div class="login-role">Espace Assistante</div>
    <div class="login-icon">üë©‚Äç‚öïÔ∏è</div>
    <input class="login-input" type="password" id="pwdInput" placeholder="Mot de passe" onkeydown="if(event.key==='Enter')login()"/>
    <button class="login-btn" onclick="login()">Se connecter</button>
    <div class="login-err" id="loginErr">Mot de passe incorrect.</div>
  </div>
</div>

<div class="dashboard" id="dashboard">
  <div class="topbar">
    <div class="topbar-logo">Rend<span>z</span></div>
    <div class="topbar-right">
      <span class="topbar-date" id="dateDisplay"></span>
      <span><span class="live-dot"></span></span>
      <button class="logout-btn" onclick="logout()">D√©connexion</button>
    </div>
  </div>

  <div id="consultBar"></div>

  <div class="stats-row">
    <div class="stat-card"><div class="stat-val" id="statTotal">0</div><div class="stat-lbl">Inscrits</div></div>
    <div class="stat-card"><div class="stat-val" id="statPresent">0</div><div class="stat-lbl">Pr√©sents</div></div>
    <div class="stat-card"><div class="stat-val" id="statAbsent">0</div><div class="stat-lbl">Absents</div></div>
    <div class="stat-card"><div class="stat-val" id="statAttente">0</div><div class="stat-lbl">En attente</div></div>
    <div class="stat-card"><div class="stat-val" id="statTermine">0</div><div class="stat-lbl">Termin√©s</div></div>
  </div>

  <div class="content">
    <div class="two-col">
      <div>
        <div class="section-title">
          File d'attente du jour
          <button class="refresh-btn" onclick="loadList()">‚Üª Actualiser</button>
        </div>
        <div class="list-wrap">
          <div class="list-header">
            <span>#</span><span>Patient</span>
            <span class="status-col">Statut</span>
            <span style="text-align:right">Actions</span>
          </div>
          <div id="listBody"></div>
        </div>
      </div>

      <div class="manual-form">
        <h3>‚ûï Inscrire un patient sur place</h3>
        <div class="mform-group">
          <label class="mform-label">Nom</label>
          <input class="mform-input" type="text" id="mNom" placeholder="Nom du patient" autocomplete="off"/>
        </div>
        <div class="mform-group">
          <label class="mform-label">Pr√©nom</label>
          <input class="mform-input" type="text" id="mPrenom" placeholder="Pr√©nom" autocomplete="off"/>
        </div>
        <div class="mform-group">
          <label class="mform-label">T√©l√©phone (optionnel)</label>
          <input class="mform-input" type="tel" id="mTel" placeholder="0xxxxxxxxx" autocomplete="off"/>
        </div>
        <button class="add-btn" id="addBtn" onclick="inscrireManuel()">‚ûï Ajouter √† la liste</button>
        <div class="add-success" id="addSuccess"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://rynxvdqjplqccekulcfe.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bnh2ZHFqcGxxY2Nla3VsY2ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNDY5ODQsImV4cCI6MjA4NzcyMjk4NH0.Ab-HQgVhGzxdyXbY8xeFF0HveQGxstNgEIUeELVPWk8';
  let refreshInterval;
  const SL = { en_attente: 'En attente', present: 'Pr√©sent', en_cours: 'En consultation', absent: 'Absent', termine: 'Termin√©' };

  async function login() {
    const pwd = document.getElementById('pwdInput').value;
    const res = await fetch(`${SUPABASE_URL}/rest/v1/utilisateurs?role=eq.assistante`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
    const data = await res.json();
    if (data.length > 0 && data[0].mot_de_passe === pwd) {
      document.getElementById('loginWrap').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      setDate(); loadList();
      refreshInterval = setInterval(loadList, 15000);
    } else { document.getElementById('loginErr').style.display = 'block'; }
  }

  function logout() {
    clearInterval(refreshInterval);
    document.getElementById('loginWrap').style.display = 'flex';
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('pwdInput').value = '';
    document.getElementById('loginErr').style.display = 'none';
  }

  function setDate() {
    document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('fr-FR', { weekday:'long', day:'numeric', month:'long' });
  }

  async function inscrireManuel() {
    const nom = document.getElementById('mNom').value.trim();
    const prenom = document.getElementById('mPrenom').value.trim();
    const telephone = document.getElementById('mTel').value.trim() || '‚Äî';
    if (!nom || !prenom) { alert('Nom et pr√©nom obligatoires.'); return; }
    document.getElementById('addBtn').disabled = true;
    const today = new Date().toISOString().split('T')[0];
    const countRes = await fetch(`${SUPABASE_URL}/rest/v1/inscriptions?date_inscription=eq.${today}&select=id`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Prefer': 'count=exact' } });
    const countHeader = countRes.headers.get('content-range');
    const currentCount = countHeader ? parseInt(countHeader.split('/')[1]) || 0 : 0;
    const position = currentCount + 1;
    const res = await fetch(`${SUPABASE_URL}/rest/v1/inscriptions`, {
      method: 'POST',
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
      body: JSON.stringify({ nom, prenom, telephone, position, date_inscription: today, statut: 'present', source: 'manuel' })
    });
    if (res.ok) {
      document.getElementById('mNom').value = '';
      document.getElementById('mPrenom').value = '';
      document.getElementById('mTel').value = '';
      const s = document.getElementById('addSuccess');
      s.textContent = `‚úì ${nom} ${prenom} ‚Äî Num√©ro ${position}`;
      s.style.display = 'block';
      setTimeout(() => s.style.display = 'none', 3000);
      loadList();
    } else { alert('Erreur. R√©essayez.'); }
    document.getElementById('addBtn').disabled = false;
  }

  async function loadList() {
    const today = new Date().toISOString().split('T')[0];
    const [listRes, paramRes] = await Promise.all([
      fetch(`${SUPABASE_URL}/rest/v1/inscriptions?date_inscription=eq.${today}&order=position.asc`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }),
      fetch(`${SUPABASE_URL}/rest/v1/parametres?id=eq.1`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } })
    ]);
    const list = await listRes.json();
    const params = (await paramRes.json())[0] || {};
    const enCours = list.find(p => p.statut === 'en_cours');
    const consultBar = document.getElementById('consultBar');
    if (enCours) {
      consultBar.innerHTML = `<div class="consult-bar"><div><div class="consult-label">üî¥ En consultation</div><div class="consult-number">${enCours.position}</div><div class="consult-name">${enCours.nom} ${enCours.prenom} ¬∑ ${enCours.telephone}</div></div><button class="fin-btn" onclick="finConsultation(${enCours.id})">‚úÖ Fin de consultation</button></div>`;
    } else {
      consultBar.innerHTML = `<div class="no-consult">‚è≥ Aucune consultation en cours</div>`;
    }
    document.getElementById('statTotal').textContent = list.length;
    document.getElementById('statPresent').textContent = list.filter(p => p.statut === 'present').length;
    document.getElementById('statAbsent').textContent = list.filter(p => p.statut === 'absent').length;
    document.getElementById('statAttente').textContent = list.filter(p => p.statut === 'en_attente').length;
    document.getElementById('statTermine').textContent = list.filter(p => p.statut === 'termine').length;
    const body = document.getElementById('listBody');
    if (list.length === 0) { body.innerHTML = `<div class="empty-state"><div class="ico">üì≠</div><p>Aucun patient inscrit pour aujourd'hui.</p></div>`; return; }
    const dejaEnCours = list.some(x => x.statut === 'en_cours');
    body.innerHTML = list.map(p => {
      const st = p.statut || 'en_attente';
      const isM = p.source === 'manuel';
      const bc = st === 'present' ? 'present' : st === 'en_cours' ? 'en_cours' : st === 'absent' ? 'absent' : st === 'termine' ? 'termine' : '';
      return `<div class="list-item ${st} ${isM ? 'manuel' : ''}">
        <div><div class="num-badge ${bc}">${p.position}</div></div>
        <div class="name-col">${p.nom} ${p.prenom}${isM ? '<span class="tag-manuel">Sur place</span>' : ''}<div class="tel">${p.telephone !== '‚Äî' ? p.telephone : ''}</div></div>
        <div class="status-col"><span class="status-badge ${st}">${SL[st] || st}</span></div>
        <div class="actions-col">
          ${st === 'en_attente' ? `<button class="action-btn btn-present" onclick="setStatut(${p.id},'present')">‚úì Pr√©sent</button>` : ''}
          ${st === 'present' && !dejaEnCours ? `<button class="action-btn btn-encours" onclick="appelConsultation(${p.id},${p.position})">‚ñ∂ Appeler</button>` : ''}
          ${st === 'en_cours' ? `<button class="action-btn btn-fin" onclick="finConsultation(${p.id})">‚úÖ Fin</button>` : ''}
          ${st !== 'absent' && st !== 'termine' ? `<button class="action-btn btn-absent" onclick="setStatut(${p.id},'absent')">‚úó Absent</button>` : ''}
          ${st === 'absent' ? `<button class="action-btn btn-restore" onclick="setStatut(${p.id},'en_attente')">‚Ü© Restaurer</button>` : ''}
          <button class="action-btn btn-del" onclick="supprimer(${p.id})">üóë</button>
        </div>
      </div>`;
    }).join('');
  }

  async function appelConsultation(id, position) {
    await Promise.all([
      fetch(`${SUPABASE_URL}/rest/v1/inscriptions?id=eq.${id}`, { method: 'PATCH', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ statut: 'en_cours' }) }),
      fetch(`${SUPABASE_URL}/rest/v1/parametres?id=eq.1`, { method: 'PATCH', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ numero_en_cours: position }) })
    ]);
    loadList();
  }

  async function finConsultation(id) {
    await fetch(`${SUPABASE_URL}/rest/v1/inscriptions?id=eq.${id}`, { method: 'PATCH', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ statut: 'termine' }) });
    loadList();
  }

  async function setStatut(id, statut) {
    await fetch(`${SUPABASE_URL}/rest/v1/inscriptions?id=eq.${id}`, { method: 'PATCH', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ statut }) });
    loadList();
  }

  async function supprimer(id) {
    if (!confirm('Supprimer ce patient ?')) return;
    await fetch(`${SUPABASE_URL}/rest/v1/inscriptions?id=eq.${id}`, { method: 'DELETE', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
    loadList();
  }

  document.getElementById('pwdInput').addEventListener('keydown', e => { if(e.key==='Enter') login(); });
</script>
</body>
</html>
