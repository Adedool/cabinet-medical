<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Assistante ‚Äî Cabinet M√©dical</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --cream: #f5f0e8; --white: #ffffff; --deep: #1a2639;
      --teal: #2a7f7f; --teal-light: #3aa3a3;
      --red: #c0392b; --green: #27ae60; --orange: #e67e22;
      --gray: #8a9bb0; --border: #ddd6c8;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Cairo', sans-serif; background: var(--cream); min-height: 100vh; }

    /* LOGIN */
    .login-wrap { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .login-card { background: white; border-radius: 18px; padding: 40px 32px; width: 100%; max-width: 400px; box-shadow: 0 4px 24px rgba(26,38,57,0.10); border: 1px solid var(--border); text-align: center; }
    .login-card .icon { font-size: 48px; margin-bottom: 12px; }
    .login-card h2 { font-family: 'Playfair Display', serif; color: var(--deep); font-size: 22px; margin-bottom: 6px; }
    .login-card p { color: var(--gray); font-size: 13px; margin-bottom: 24px; }
    .login-card input { width: 100%; padding: 12px 16px; border: 1.5px solid var(--border); border-radius: 10px; font-family: 'Cairo', sans-serif; font-size: 15px; color: var(--deep); background: var(--cream); margin-bottom: 14px; outline: none; }
    .login-card input:focus { border-color: var(--teal); background: white; }
    .login-btn { width: 100%; padding: 13px; background: var(--teal); color: white; border: none; border-radius: 10px; font-family: 'Cairo', sans-serif; font-size: 15px; font-weight: 700; cursor: pointer; transition: background 0.2s; }
    .login-btn:hover { background: var(--teal-light); }
    .error-login { color: var(--red); font-size: 13px; margin-top: 10px; display: none; }

    /* DASHBOARD */
    .dashboard { display: none; }
    .topbar { background: var(--deep); color: white; padding: 16px 28px; display: flex; align-items: center; justify-content: space-between; }
    .topbar h1 { font-family: 'Playfair Display', serif; font-size: 20px; }
    .topbar .meta { font-size: 13px; color: var(--gray); }
    .logout-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 7px 16px; border-radius: 8px; cursor: pointer; font-family: 'Cairo', sans-serif; font-size: 13px; }

    /* CONSULTATION EN COURS */
    .consult-bar { background: var(--orange); color: white; padding: 16px 28px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
    .consult-bar .left .label { font-size: 12px; opacity: 0.85; margin-bottom: 2px; }
    .consult-bar .left .number { font-family: 'Playfair Display', serif; font-size: 40px; font-weight: 700; line-height: 1; }
    .consult-bar .left .name { font-size: 13px; opacity: 0.9; margin-top: 4px; }
    .fin-btn { background: white; color: var(--orange); border: none; border-radius: 10px; padding: 12px 24px; font-family: 'Cairo', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .fin-btn:hover { background: var(--deep); color: white; }
    .no-consult-bar { background: #f8f6f2; color: var(--gray); padding: 14px 28px; font-size: 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }

    /* STATS */
    .stats-row { display: flex; gap: 14px; padding: 20px 28px 0; flex-wrap: wrap; }
    .stat-card { background: white; border-radius: 12px; padding: 16px 20px; flex: 1; min-width: 100px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(26,38,57,0.05); }
    .stat-card .val { font-size: 26px; font-weight: 700; color: var(--teal); font-family: 'Playfair Display', serif; }
    .stat-card .lbl { font-size: 11px; color: var(--gray); margin-top: 2px; }

    /* CONTENU */
    .content { padding: 20px 28px; }
    .two-col { display: grid; grid-template-columns: 1fr 340px; gap: 20px; align-items: start; }

    /* FORMULAIRE INSCRIPTION MANUELLE */
    .manual-form {
      background: white; border-radius: 14px; border: 1px solid var(--border);
      padding: 22px; box-shadow: 0 2px 8px rgba(26,38,57,0.05);
      position: sticky; top: 20px;
    }
    .manual-form h3 {
      font-size: 15px; font-weight: 700; color: var(--deep);
      margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
    }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; color: var(--gray); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.3px; }
    .form-group input { width: 100%; padding: 10px 14px; border: 1.5px solid var(--border); border-radius: 8px; font-family: 'Cairo', sans-serif; font-size: 14px; color: var(--deep); background: var(--cream); outline: none; transition: border-color 0.2s; }
    .form-group input:focus { border-color: var(--teal); background: white; }
    .add-btn { width: 100%; padding: 12px; background: var(--deep); color: white; border: none; border-radius: 10px; font-family: 'Cairo', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; transition: background 0.2s; margin-top: 4px; }
    .add-btn:hover { background: var(--teal); }
    .add-btn:disabled { background: var(--gray); cursor: not-allowed; }
    .success-msg { background: #e8f8f0; border: 1px solid #b2dfdb; border-radius: 8px; padding: 10px 14px; color: var(--green); font-size: 13px; font-weight: 600; text-align: center; margin-top: 12px; display: none; }

    /* LISTE */
    .section-title { font-size: 16px; font-weight: 700; color: var(--deep); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
    .refresh-btn { background: none; border: 1.5px solid var(--teal); color: var(--teal); border-radius: 8px; padding: 5px 14px; font-size: 12px; cursor: pointer; font-family: 'Cairo', sans-serif; }
    .list-wrap { background: white; border-radius: 14px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 2px 8px rgba(26,38,57,0.05); }
    .list-header { display: grid; grid-template-columns: 50px 1fr 110px 200px; padding: 12px 20px; background: #f8f6f2; border-bottom: 1px solid var(--border); font-size: 12px; font-weight: 700; color: var(--gray); text-transform: uppercase; }
    .list-item { display: grid; grid-template-columns: 50px 1fr 110px 200px; padding: 12px 20px; border-bottom: 1px solid #f0ece4; align-items: center; transition: background 0.15s; }
    .list-item:last-child { border-bottom: none; }
    .list-item.en_cours { background: #fff8f0; border-left: 4px solid var(--orange); }
    .list-item.absent { opacity: 0.55; }
    .list-item.termine { opacity: 0.45; background: #f9f9f9; }
    .list-item.manuel { border-left: 3px solid var(--deep); }

    .num-badge { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; font-family: 'Playfair Display', serif; color: white; background: var(--teal); }
    .num-badge.present { background: var(--green); }
    .num-badge.en_cours { background: var(--orange); }
    .num-badge.absent { background: var(--gray); }
    .num-badge.termine { background: #ccc; }
    .num-badge.manuel { background: var(--deep); }

    .name-col { font-weight: 600; color: var(--deep); font-size: 14px; }
    .name-col .tel { font-size: 12px; color: var(--gray); font-weight: 400; margin-top: 2px; }
    .name-col .tag { font-size: 10px; background: #eef0f5; color: var(--gray); border-radius: 4px; padding: 1px 6px; margin-left: 6px; font-weight: 600; }

    .status-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
    .status-badge.en_attente { background: #f0f4ff; color: #5b7fd4; }
    .status-badge.present { background: #e8f8f0; color: var(--green); }
    .status-badge.en_cours { background: #fff4e6; color: var(--orange); }
    .status-badge.absent { background: #f5f5f5; color: var(--gray); }
    .status-badge.termine { background: #f0f0f0; color: #aaa; }

    .actions-col { display: flex; gap: 5px; flex-wrap: wrap; justify-content: flex-end; }
    .action-btn { border: none; border-radius: 6px; padding: 5px 9px; font-size: 11px; cursor: pointer; font-family: 'Cairo', sans-serif; font-weight: 600; transition: all 0.15s; white-space: nowrap; }
    .btn-present { background: #e8f8f0; color: var(--green); border: 1.5px solid #b2dfdb; }
    .btn-present:hover { background: var(--green); color: white; }
    .btn-encours { background: #fff4e6; color: var(--orange); border: 1.5px solid #ffd59e; }
    .btn-encours:hover { background: var(--orange); color: white; }
    .btn-fin { background: var(--green); color: white; border: 1.5px solid var(--green); }
    .btn-fin:hover { background: #1e8449; }
    .btn-absent { background: #f5f5f5; color: var(--gray); border: 1.5px solid #ddd; }
    .btn-absent:hover { background: var(--gray); color: white; }
    .btn-del { background: #fdf2f2; color: var(--red); border: 1.5px solid #f5c6cb; }
    .btn-del:hover { background: var(--red); color: white; }

    .empty-state { text-align: center; padding: 48px 20px; color: var(--gray); }
    .empty-state .ico { font-size: 48px; margin-bottom: 12px; }
    .live-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }

    @media (max-width: 900px) {
      .two-col { grid-template-columns: 1fr; }
      .manual-form { position: static; }
    }
    @media (max-width: 640px) {
      .list-header, .list-item { grid-template-columns: 45px 1fr 160px; }
      .list-header span:nth-child(3), .list-item .status-col { display: none; }
      .stats-row { flex-wrap: wrap; }
      .topbar, .content { padding-left: 16px; padding-right: 16px; }
      .stats-row { padding: 16px 16px 0; }
      .consult-bar, .no-consult-bar { padding: 14px 16px; }
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="login-wrap" id="loginWrap">
  <div class="login-card">
    <div class="icon">üë©‚Äç‚öïÔ∏è</div>
    <h2>Espace Assistante</h2>
    <p>Connectez-vous pour g√©rer la liste des patients</p>
    <input type="password" id="pwdInput" placeholder="Mot de passe" onkeydown="if(event.key==='Enter')login()"/>
    <button class="login-btn" onclick="login()">Se connecter</button>
    <div class="error-login" id="loginErr">Mot de passe incorrect.</div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboard">
  <div class="topbar">
    <div>
      <h1>üè• Liste des patients</h1>
      <div class="meta" id="dateDisplay"></div>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <span><span class="live-dot"></span> <span style="font-size:12px;color:#8a9bb0;margin-left:4px;">Temps r√©el</span></span>
      <button class="logout-btn" onclick="logout()">D√©connexion</button>
    </div>
  </div>

  <div id="consultBar"></div>

  <div class="stats-row">
    <div class="stat-card"><div class="val" id="statTotal">0</div><div class="lbl">Inscrits</div></div>
    <div class="stat-card"><div class="val" id="statPresent">0</div><div class="lbl">Pr√©sents</div></div>
    <div class="stat-card"><div class="val" id="statAbsent">0</div><div class="lbl">Absents</div></div>
    <div class="stat-card"><div class="val" id="statAttente">0</div><div class="lbl">En attente</div></div>
    <div class="stat-card"><div class="val" id="statTermine">0</div><div class="lbl">Termin√©s</div></div>
  </div>

  <div class="content">
    <div class="two-col">

      <!-- LISTE -->
      <div>
        <div class="section-title">
          üìã File d'attente du jour
          <button class="refresh-btn" onclick="loadList()">‚Üª Actualiser</button>
        </div>
        <div class="list-wrap">
          <div class="list-header">
            <span>#</span>
            <span>Patient</span>
            <span class="status-col">Statut</span>
            <span style="text-align:right">Actions</span>
          </div>
          <div id="listBody"></div>
        </div>
      </div>

      <!-- FORMULAIRE INSCRIPTION MANUELLE -->
      <div class="manual-form">
        <h3>‚ûï Inscrire un patient sur place</h3>
        <div class="form-group">
          <label>Nom</label>
          <input type="text" id="mNom" placeholder="Nom du patient" autocomplete="off"/>
        </div>
        <div class="form-group">
          <label>Pr√©nom</label>
          <input type="text" id="mPrenom" placeholder="Pr√©nom" autocomplete="off"/>
        </div>
        <div class="form-group">
          <label>T√©l√©phone</label>
          <input type="tel" id="mTel" placeholder="0xxxxxxxxx" autocomplete="off"/>
        </div>
        <button class="add-btn" id="addBtn" onclick="inscrireManuel()">
          ‚ûï Ajouter √† la liste
        </button>
        <div class="success-msg" id="successMsg"></div>
      </div>

    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://rynxvdqjplqccekulcfe.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bnh2ZHFqcGxxY2Nla3VsY2ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNDY5ODQsImV4cCI6MjA4NzcyMjk4NH0.Ab-HQgVhGzxdyXbY8xeFF0HveQGxstNgEIUeELVPWk8';
  let refreshInterval;
  const statutLabels = { en_attente: 'En attente', present: 'Pr√©sent', en_cours: 'En consultation', absent: 'Absent', termine: 'Termin√©' };

  async function login() {
    const pwd = document.getElementById('pwdInput').value;
    const res = await fetch(`${SUPABASE_URL}/rest/v1/utilisateurs?role=eq.assistante`, {
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
    });
    const data = await res.json();
    if (data.length > 0 && data[0].mot_de_passe === pwd) {
      document.getElementById('loginWrap').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      setDate(); loadList();
      refreshInterval = setInterval(loadList, 15000);
    } else {
      document.getElementById('loginErr').style.display = 'block';
    }
  }

  function logout() {
    clearInterval(refreshInterval);
    document.getElementById('loginWrap').style.display = 'flex';
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('pwdInput').value = '';
    document.getElementById('loginErr').style.display = 'none';
  }

  function setDate() {
    document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  }

  async function inscrireManuel() {
    const nom = document.getElementById('mNom').value.trim();
    const prenom = document.getElementById('mPrenom').value.trim();
    const telephone = document.getElementById('mTel').value.trim() || '‚Äî';
    if (!nom || !prenom) { alert('Nom et pr√©nom obligatoires.'); return; }

    document.getElementById('addBtn').disabled = true;

    const today = new Date().toISOString().split('T')[0];
    const countRes = await fetch(`${SUPABASE_URL}/rest/v1/inscriptions?date_inscription=eq.${today}&select=id`, {
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Prefer': 'count=exact' }
    });
    const countHeader = countRes.headers.get('content-range');
    const currentCount = countHeader ? parseInt(countHeader.split('/')[1]) || 0 : 0;
    const position = currentCount + 1;

    const res = await fetch(`${SUPABASE_URL}/rest/v1/inscriptions`, {
      method: 'POST',
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
      body: JSON.stringify({ nom, prenom, telephone, position, date_inscription: today, statut: 'present', source: 'manuel' })
    });

    if (res.ok) {
      document.getElementById('mNom').value = '';
      document.getElementById('mPrenom').value = '';
      document.getElementById('mTel').value = '';
      const msg = document.getElementById('successMsg');
      msg.textContent = `‚úì ${nom} ${prenom} ajout√© ‚Äî Num√©ro ${position}`;
      msg.style.display = 'block';
      setTimeout(() => msg.style.display = 'none', 3000);
      loadList();
    } else {
      alert('Erreur lors de l\'inscription. R√©essayez.');
    }
    document.getElementById('addBtn').disabled = false;
  }

  async function loadList() {
    const today = new Date().toISOString().split('T')[0];
    const [listRes, paramRes] = await Promise.all([
      fetch(`${SUPABASE_URL}/rest/v1/inscriptions?date_inscription=eq.${today}&order=position.asc`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      }),
      fetch(`${SUPABASE_URL}/rest/v1/parametres?id=eq.1`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      })
    ]);
    const list = await listRes.json();
    const params = (await paramRes.json())[0] || {};

    // Barre consultation en cours
    const enCours = list.find(p => p.statut === 'en_cours');
    const consultBar = document.getElementById('consultBar');
    if (enCours) {
      consultBar.innerHTML = `
        <div class="consult-bar">
          <div class="left">
            <div class="label">üî¥ En consultation actuellement</div>
            <div class="number">${enCours.position}</div>
            <div class="name">${enCours.nom} ${enCours.prenom} ‚Äî ${enCours.telephone}</div>
          </div>
          <button class="fin-btn" onclick="finConsultation(${enCours.id})">‚úÖ Fin de consultation</button>
        </div>`;
    } else {
      consultBar.innerHTML = `<div class="no-consult-bar">‚è≥ Aucune consultation en cours</div>`;
    }

    // Stats
    document.getElementById('statTotal').textContent = list.length;
    document.getElementById('statPresent').textContent = list.filter(p => p.statut === 'present').length;
    document.getElementById('statAbsent').textContent = list.filter(p => p.statut === 'absent').length;
    document.getElementById('statAttente').textContent = list.filter(p => p.statut === 'en_attente').length;
    document.getElementById('statTermine').textContent = list.filter(p => p.statut === 'termine').length;

    const body = document.getElementById('listBody');
    if (list.length === 0) {
      body.innerHTML = `<div class="empty-state"><div class="ico">üì≠</div><p>Aucun patient inscrit pour aujourd'hui.</p></div>`;
      return;
    }

    const dejaEnCours = list.some(x => x.statut === 'en_cours');
    body.innerHTML = list.map(p => {
      const st = p.statut || 'en_attente';
      const isManuel = p.source === 'manuel';
      const badgeClass = st === 'present' ? 'present' : st === 'en_cours' ? 'en_cours' : st === 'absent' ? 'absent' : st === 'termine' ? 'termine' : isManuel ? 'manuel' : '';
      return `<div class="list-item ${st} ${isManuel ? 'manuel' : ''}">
        <div><div class="num-badge ${badgeClass}">${p.position}</div></div>
        <div class="name-col">
          ${p.nom} ${p.prenom}
          ${isManuel ? '<span class="tag">Sur place</span>' : ''}
          <div class="tel">${p.telephone !== '‚Äî' ? p.telephone : ''}</div>
        </div>
        <div class="status-col"><span class="status-badge ${st}">${statutLabels[st] || st}</span></div>
        <div class="actions-col">
          ${st === 'en_attente' ? `<button class="action-btn btn-present" onclick="setStatut(${p.id},'present')">‚úì Pr√©sent</button>` : ''}
          ${st === 'present' && !dejaEnCours ? `<button class="action-btn btn-encours" onclick="appelConsultation(${p.id}, ${p.position})">‚ñ∂ Appeler</button>` : ''}
          ${st === 'en_cours' ? `<button class="action-btn btn-fin" onclick="finConsultation(${p.id})">‚úÖ Fin</button>` : ''}
          ${st !== 'absent' && st !== 'termine' ? `<button class="action-btn btn-absent" onclick="setStatut(${p.id},'absent')">‚úó Absent</button>` : ''}
          ${st === 'absent' ? `<button class="action-btn btn-present" onclick="setStatut(${p.id},'en_attente')">‚Ü© Restaurer</button>` : ''}
          <button class="action-btn btn-del" onclick="supprimer(${p.id})">üóë</button>
        </div>
      </div>`;
    }).join('');
  }

  async function appelConsultation(id, position) {
    await Promise.all([
      fetch(`${SUPABASE_URL}/rest/v1/inscriptions?id=eq.${id}`, {
        method: 'PATCH',
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ statut: 'en_cours' })
      }),
      fetch(`${SUPABASE_URL}/rest/v1/parametres?id=eq.1`, {
        method: 'PATCH',
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ numero_en_cours: position })
      })
    ]);
    loadList();
  }

  async function finConsultation(id) {
    await fetch(`${SUPABASE_URL}/rest/v1/inscriptions?id=eq.${id}`, {
      method: 'PATCH',
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ statut: 'termine' })
    });
    loadList();
  }

  async function setStatut(id, statut) {
    await fetch(`${SUPABASE_URL}/rest/v1/inscriptions?id=eq.${id}`, {
      method: 'PATCH',
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ statut })
    });
    loadList();
  }

  async function supprimer(id) {
    if (!confirm('Supprimer ce patient ?')) return;
    await fetch(`${SUPABASE_URL}/rest/v1/inscriptions?id=eq.${id}`, {
      method: 'DELETE',
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
    });
    loadList();
  }

  document.getElementById('pwdInput').addEventListener('keydown', e => { if(e.key==='Enter') login(); });
</script>
</body>
</html>
